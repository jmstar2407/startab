<!-- login.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarTab - Iniciar Sesi√≥n</title>
    <link rel="stylesheet" href="login.css">
    <!-- Firebase LOCAL (descargado) -->
    <script src="lib/firebase-app-compat.js"></script>
    <script src="lib/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-titulo">StarTab</h1>
                <p class="login-subtitulo">Inicia sesi√≥n para sincronizar tus accesos directos</p>
            </div>
            
            <div class="login-content">
                <div class="login-beneficios">
                    <div class="beneficio-item">
                        <span class="beneficio-icono">‚òÅÔ∏è</span>
                        <span>Sincronizaci√≥n en la nube</span>
                    </div>
                    <div class="beneficio-item">
                        <span class="beneficio-icono">üì±</span>
                        <span>Accede desde cualquier dispositivo</span>
                    </div>
                    <div class="beneficio-item">
                        <span class="beneficio-icono">üîí</span>
                        <span>Tus datos seguros con Google</span>
                    </div>
                </div>

                <div class="login-mensaje" id="login-mensaje"></div>
                
                <button class="google-btn" id="google-login-btn">
                    <img src="https://www.google.com/favicon.ico" alt="Google" class="google-icon">
                    <span>Continuar con Google</span>
                </button>

                <div class="login-nota">
                    <p>‚ö†Ô∏è Ser√°s redirigido a Google y luego regresar√°s autom√°ticamente</p>
                </div>
            </div>
            
            <div class="login-footer">
                <p>¬© 2024 StarTab. Todos los derechos reservados.</p>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBU8DyN2kRcDq0fxB20qRUXWBHV0E-0d6A",
            authDomain: "startab-44e48.firebaseapp.com",
            projectId: "startab-44e48",
            storageBucket: "startab-44e48.firebasestorage.app",
            messagingSenderId: "874084877753",
            appId: "1:874084877753:web:cf9cbe9a344356dc9be268"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // Configurar persistencia LOCAL antes que nada
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('Persistencia LOCAL configurada en login.html');
            })
            .catch((error) => {
                console.error('Error configurando persistencia:', error);
            });

        // Configuraci√≥n del provider
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        const loginBtn = document.getElementById('google-login-btn');
        const mensajeDiv = document.getElementById('login-mensaje');

        // Verificar si ya hay sesi√≥n activa al cargar
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Usuario ya autenticado en login.html:', user.email);
                mensajeDiv.className = 'login-mensaje success';
                mensajeDiv.textContent = '‚úÖ Ya tienes sesi√≥n iniciada. Redirigiendo...';
                
                // Intentar cerrar esta ventana y notificar a la ventana padre
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'AUTH_SUCCESS',
                        user: {
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL
                        }
                    }, '*');
                    
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    // Si no hay opener, redirigir a index.html
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            }
        });

        async function iniciarSesion() {
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="spinner"></span><span>Redirigiendo a Google...</span>';
                mensajeDiv.className = 'login-mensaje info';
                mensajeDiv.textContent = 'Ser√°s redirigido a Google para iniciar sesi√≥n...';

                // Usar redirect en lugar de popup para mejor compatibilidad
                await auth.signInWithRedirect(googleProvider);
                
                // Nota: El c√≥digo despu√©s de esto no se ejecutar√° porque hay una redirecci√≥n
                
            } catch (error) {
                console.error('Error en autenticaci√≥n:', error);
                
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<img src="https://www.google.com/favicon.ico" alt="Google" class="google-icon"><span>Continuar con Google</span>';
                
                mensajeDiv.className = 'login-mensaje error';
                mensajeDiv.textContent = '‚ùå Error: ' + error.message;
            }
        }

        loginBtn.addEventListener('click', iniciarSesion);

        // Procesar el resultado del redirect cuando se vuelve a esta p√°gina
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log('Redirect result successful:', result.user.email);
                mensajeDiv.className = 'login-mensaje success';
                mensajeDiv.textContent = '‚úÖ Inicio de sesi√≥n exitoso!';
                
                // Enviar mensaje a la ventana padre si existe
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'AUTH_SUCCESS',
                        user: {
                            uid: result.user.uid,
                            displayName: result.user.displayName,
                            email: result.user.email,
                            photoURL: result.user.photoURL
                        }
                    }, '*');
                    
                    setTimeout(() => {
                        window.close();
                    }, 1500);
                } else {
                    // Si no hay opener, redirigir a index.html
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                }
            }
        }).catch((error) => {
            console.error('Error en redirect result:', error);
            // Ignorar errores de popup cerrado
            if (error.code !== 'auth/popup-closed-by-user') {
                mensajeDiv.className = 'login-mensaje error';
                mensajeDiv.textContent = '‚ùå Error: ' + error.message;
            }
        });
    </script>
</body>
</html>