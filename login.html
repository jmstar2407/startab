<!-- login.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarTab - Iniciar Sesi√≥n</title>
    <link rel="stylesheet" href="login.css">
    <!-- Firebase LOCAL (descargado) -->
    <script src="lib/firebase-app-compat.js"></script>
    <script src="lib/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-titulo">StarTab</h1>
                <p class="login-subtitulo">Inicia sesi√≥n para sincronizar tus accesos directos</p>
            </div>
            
            <div class="login-content">
                <div class="login-beneficios">
                    <div class="beneficio-item">
                        <span class="beneficio-icono">‚òÅÔ∏è</span>
                        <span>Sincronizaci√≥n en la nube</span>
                    </div>
                    <div class="beneficio-item">
                        <span class="beneficio-icono">üì±</span>
                        <span>Accede desde cualquier dispositivo</span>
                    </div>
                    <div class="beneficio-item">
                        <span class="beneficio-icono">üîí</span>
                        <span>Tus datos seguros con Google</span>
                    </div>
                </div>

                <div class="login-mensaje" id="login-mensaje"></div>
                
                <button class="google-btn" id="google-login-btn">
                    <img src="https://www.google.com/favicon.ico" alt="Google" class="google-icon">
                    <span>Continuar con Google</span>
                </button>

                <div class="login-nota">
                    <p>‚ö†Ô∏è Ser√°s redirigido a Google y luego regresar√°s autom√°ticamente</p>
                </div>
            </div>
            
            <div class="login-footer">
                <p>¬© 2024 StarTab. Todos los derechos reservados.</p>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBU8DyN2kRcDq0fxB20qRUXWBHV0E-0d6A",
            authDomain: "startab-44e48.firebaseapp.com",
            projectId: "startab-44e48",
            storageBucket: "startab-44e48.firebasestorage.app",
            messagingSenderId: "874084877753",
            appId: "1:874084877753:web:cf9cbe9a344356dc9be268"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // Configurar persistencia LOCAL antes que nada - ESTO ES CR√çTICO
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('Persistencia LOCAL configurada en login.html');
                
                // Verificar si es un retorno de redirect
                return auth.getRedirectResult();
            })
            .then((result) => {
                if (result.user) {
                    console.log('Redirect result successful:', result.user.email);
                    
                    // Guardar en localStorage como respaldo
                    localStorage.setItem('lastUser', JSON.stringify({
                        uid: result.user.uid,
                        displayName: result.user.displayName,
                        email: result.user.email,
                        photoURL: result.user.photoURL
                    }));
                    
                    mostrarMensajeExito();
                    
                    // Enviar mensaje a la ventana padre si existe
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'AUTH_SUCCESS',
                            user: {
                                uid: result.user.uid,
                                displayName: result.user.displayName,
                                email: result.user.email,
                                photoURL: result.user.photoURL
                            }
                        }, '*');
                        
                        setTimeout(() => {
                            window.close();
                        }, 1500);
                    } else {
                        // Si no hay opener, redirigir a index.html
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    }
                }
            })
            .catch((error) => {
                console.error('Error en redirect result:', error);
                // Ignorar errores de popup cerrado
                if (error.code !== 'auth/popup-closed-by-user') {
                    const mensajeDiv = document.getElementById('login-mensaje');
                    if (mensajeDiv) {
                        mensajeDiv.className = 'login-mensaje error';
                        mensajeDiv.textContent = '‚ùå Error: ' + error.message;
                    }
                }
            });

        // Configuraci√≥n del provider
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        const loginBtn = document.getElementById('google-login-btn');
        const mensajeDiv = document.getElementById('login-mensaje');

        // Verificar si ya hay sesi√≥n activa al cargar
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Usuario ya autenticado en login.html:', user.email);
                
                // Guardar en localStorage como respaldo
                localStorage.setItem('lastUser', JSON.stringify({
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL
                }));
                
                mostrarMensajeExito();
                
                // Intentar cerrar esta ventana y notificar a la ventana padre
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'AUTH_SUCCESS',
                        user: {
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL
                        }
                    }, '*');
                    
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    // Si no hay opener, redirigir a index.html
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            }
        });

        function mostrarMensajeExito() {
            if (mensajeDiv) {
                mensajeDiv.className = 'login-mensaje success';
                mensajeDiv.textContent = '‚úÖ Inicio de sesi√≥n exitoso!';
            }
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span>‚úÖ Sesi√≥n iniciada</span>';
            }
        }

        async function iniciarSesion() {
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="spinner"></span><span>Redirigiendo a Google...</span>';
                
                if (mensajeDiv) {
                    mensajeDiv.className = 'login-mensaje info';
                    mensajeDiv.textContent = 'Ser√°s redirigido a Google para iniciar sesi√≥n...';
                }

                // Usar redirect con la persistencia ya configurada
                await auth.signInWithRedirect(googleProvider);
                
            } catch (error) {
                console.error('Error en autenticaci√≥n:', error);
                
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<img src="https://www.google.com/favicon.ico" alt="Google" class="google-icon"><span>Continuar con Google</span>';
                
                if (mensajeDiv) {
                    mensajeDiv.className = 'login-mensaje error';
                    mensajeDiv.textContent = '‚ùå Error: ' + error.message;
                }
            }
        }

        if (loginBtn) {
            loginBtn.addEventListener('click', iniciarSesion);
        }
    </script>
</body>
</html>